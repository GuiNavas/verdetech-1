<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Resultados do Quiz | Verde Tech</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .results-wrap { max-width: 900px; margin: 40px auto; padding: 20px; }
        .answers-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
        .answer-card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; background: #fff; }
        .answer-card.correct { border-color: #16a34a33; background: #f0fdf4; }
        .answer-card.incorrect { border-color: #dc262633; background: #fef2f2; }
        .answer-title { font-weight: 600; margin-bottom: 6px; font-size: 0.9rem; }
        .answer-meta { font-size: 12px; color: #6b7280; }
        .score-hero { display:flex; align-items:center; gap:16px; margin-bottom: 24px; }
        .score-circle { width:80px; height:80px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:#e5f9e7; color:#065f46; font-size:24px; font-weight:800; }
        .btn-row { display:flex; gap:12px; margin-top: 16px; flex-wrap: wrap; }
        .btn { padding: 10px 16px; border-radius: 8px; background:#10b981; color:#fff; text-decoration:none; display:inline-flex; align-items:center; gap:8px; }
        .btn.secondary { background:#111827; }
        
        /* Estilos do feedback */
        .feedback-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }
        
        .feedback-title {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
        }
        
        .feedback-emoji-container {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .feedback-emoji {
            font-size: 3rem;
            cursor: pointer;
            padding: 1rem;
            border-radius: 50%;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }
        
        .feedback-emoji:hover {
            transform: scale(1.1);
            background: #f0f0f0;
        }
        
        .feedback-emoji.selected {
            border-color: var(--accent-color);
            background: var(--light-color);
            transform: scale(1.1);
        }
        
        .feedback-text-container {
            margin-bottom: 1.5rem;
        }
        
        .feedback-textarea {
            width: 100%;
            min-height: 100px;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            transition: border-color 0.3s ease;
        }
        
        .feedback-textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        
        .feedback-submit {
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 0 auto;
        }
        
        .feedback-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        .feedback-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .feedback-success {
            background: #f0fdf4;
            border: 1px solid #16a34a;
            color: #065f46;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            margin-top: 1rem;
            display: none;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let payload = null;
            try { payload = JSON.parse(localStorage.getItem('quizResults') || 'null'); } catch(e) {}
            if (!payload) {
                document.getElementById('content').innerHTML = '<p>Sem resultados do quiz. Faça o <a href="quiz.html">quiz</a> primeiro.</p>';
                return;
            }
            const { score, total, userAnswers, questions } = payload;
            fetch('/api/me').then(r=>r.json()).then(me => {
                const name = me && me.authenticated ? (me.nome || me.username) : '';
                if (name) {
                    const hero = document.querySelector('.hero h1');
                    if (hero) hero.textContent = `Parabéns, ${name}!`;
                    
                    // Mostrar seção de feedback apenas para usuários logados
                    const feedbackSection = document.getElementById('feedback-section');
                    if (feedbackSection) {
                        feedbackSection.style.display = 'block';
                    }
                }
            }).catch(()=>{});
            document.getElementById('score-val').textContent = score + '/' + total;
            document.getElementById('pct-val').textContent = Math.round((score/total)*100) + '%';

            const grid = document.getElementById('answers-grid');
            grid.innerHTML = '';
            questions.forEach((q, idx) => {
                const ans = userAnswers[idx];
                const isCorrect = ans === q.correct;
                const card = document.createElement('div');
                card.className = 'answer-card ' + (isCorrect ? 'correct' : 'incorrect');
                card.innerHTML = `
                    <div class="answer-title">${idx+1}. ${q.question}</div>
                    <div class="answer-meta"><strong>Sua resposta:</strong> ${ans != null ? q.options[ans] : 'Não respondida'}</div>
                    ${!isCorrect ? `<div class="answer-meta"><strong>Correta:</strong> ${q.options[q.correct]}</div>` : ''}
                `;
                grid.appendChild(card);
            });

            // Sistema de Feedback
            let selectedRating = null;
            const emojis = document.querySelectorAll('.feedback-emoji');
            const submitBtn = document.getElementById('feedback-submit');
            const textarea = document.getElementById('feedback-text');
            const charCount = document.getElementById('char-count');
            const successMsg = document.getElementById('feedback-success');

            // Carregar feedback existente do usuário
            loadExistingFeedback();

            // Função para carregar feedback existente
            async function loadExistingFeedback() {
                try {
                    const response = await fetch('/api/feedback');
                    if (response.ok) {
                        const feedback = await response.json();
                        if (feedback) {
                            // Preencher emoji selecionado
                            const emoji = document.querySelector(`[data-rating="${feedback.rating}"]`);
                            if (emoji) {
                                emoji.classList.add('selected');
                                selectedRating = feedback.rating;
                            }
                            
                            // Preencher texto
                            if (feedback.text) {
                                textarea.value = feedback.text;
                                charCount.textContent = feedback.text.length;
                            }
                            
                            // Atualizar botão
                            updateSubmitButton();
                        }
                    }
                } catch (error) {
                    console.error('Erro ao carregar feedback existente:', error);
                }
            }

            // Seleção de emoji
            emojis.forEach(emoji => {
                emoji.addEventListener('click', function() {
                    emojis.forEach(e => e.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedRating = parseInt(this.dataset.rating);
                    updateSubmitButton();
                });
            });

            // Contador de caracteres e validação em tempo real
            textarea.addEventListener('input', function() {
                const count = this.value.length;
                charCount.textContent = count;
                
                if (count > 450) {
                    charCount.style.color = '#dc2626';
                } else if (count > 400) {
                    charCount.style.color = '#f59e0b';
                } else {
                    charCount.style.color = '#6b7280';
                }
                
                // Validação em tempo real para palavrões
                const originalText = this.value;
                const filteredText = filterInappropriateContent(originalText);
                
                if (originalText !== filteredText) {
                    this.style.borderColor = '#dc2626';
                    this.style.backgroundColor = '#fef2f2';
                    
                    // Mostrar aviso
                    if (!document.getElementById('inappropriate-warning')) {
                        const warning = document.createElement('div');
                        warning.id = 'inappropriate-warning';
                        warning.style.cssText = `
                            color: #dc2626;
                            font-size: 0.8rem;
                            margin-top: 5px;
                            font-weight: 500;
                        `;
                        warning.textContent = '⚠️ Palavras inadequadas detectadas';
                        textarea.parentNode.appendChild(warning);
                    }
                } else {
                    this.style.borderColor = '';
                    this.style.backgroundColor = '';
                    const warning = document.getElementById('inappropriate-warning');
                    if (warning) {
                        warning.remove();
                    }
                }
            });

            // Atualizar botão de envio
            function updateSubmitButton() {
                submitBtn.disabled = !selectedRating;
            }

            // Função para filtrar palavrões
            function filterInappropriateContent(text) {
                const inappropriateWords = [
                    'merda', 'porra', 'caralho', 'puta', 'bosta', 'cacete', 'foda', 'cu', 'buceta',
                    'viado', 'gay', 'bicha', 'preto', 'negra', 'macaco', 'judeu', 'japa', 'china',
                    'fdp', 'pqp', 'vtf', 'fuck', 'shit', 'damn', 'bitch', 'asshole'
                ];
                
                let filteredText = text.toLowerCase();
                inappropriateWords.forEach(word => {
                    const regex = new RegExp(`\\b${word}\\b`, 'gi');
                    filteredText = filteredText.replace(regex, '*'.repeat(word.length));
                });
                
                return filteredText;
            }

            // Envio do feedback
            submitBtn.addEventListener('click', async function() {
                if (!selectedRating) return;

                const originalText = textarea.value.trim();
                const filteredText = filterInappropriateContent(originalText);
                
                // Verificar se houve filtragem
                if (originalText !== filteredText) {
                    alert('Seu feedback contém palavras inadequadas que foram filtradas. Por favor, revise e envie novamente.');
                    textarea.value = filteredText;
                    return;
                }

                const feedbackData = {
                    rating: selectedRating,
                    text: filteredText,
                    quiz_score: score,
                    quiz_total: total,
                    timestamp: new Date().toISOString()
                };

                try {
                    const response = await fetch('/api/feedback', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(feedbackData)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        
                        // Atualizar mensagem de sucesso baseada se foi atualizado ou criado
                        if (result.updated) {
                            successMsg.innerHTML = '<i class="fas fa-check-circle"></i> Seu feedback foi atualizado! Obrigado pela sua opinião.';
                        } else {
                            successMsg.innerHTML = '<i class="fas fa-check-circle"></i> Obrigado pelo seu feedback! Sua opinião é muito importante para nós.';
                        }
                        
                        successMsg.style.display = 'block';
                        submitBtn.disabled = true;
                        textarea.disabled = true;
                        emojis.forEach(e => e.style.pointerEvents = 'none');
                        
                        // Esconder seção de feedback após 3 segundos
                        setTimeout(() => {
                            document.querySelector('.feedback-section').style.opacity = '0.5';
                        }, 3000);
                    } else {
                        alert('Erro ao enviar feedback. Tente novamente.');
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao enviar feedback. Tente novamente.');
                }
            });
        });
    </script>
    
</head>
<body>
    <header>
        <div class="logo-container">
            <img src="imagens/logo.png" alt="Logo Verde Tech - Voltar ao Início" class="logo">
            <a href="/admin" class="admin-secret-btn" title="Acesso Administrativo"></a>
        </div>
        <nav>
            <a href="index.html" class="nav-link-standard">
                <i class="fas fa-home"></i>
                <span>Voltar ao Início</span>
            </a>
        </nav>
    </header>

    <div class="hero">
    </div>

    <main>
        <div class="results-wrap" id="content">
            <div class="score-hero">
                <div class="score-circle" id="pct-val">0%</div>
                <div>
                    <h2 id="score-val">0/10</h2>
                    <div class="btn-row">
                        <a class="btn" href="quiz.html"><i class="fas fa-redo"></i> Refazer quiz</a>
                        <a class="btn secondary" href="explicacoes.html"><i class="fas fa-book"></i> Aprender mais</a>
                    </div>
                </div>
            </div>
            <div class="answers-grid" id="answers-grid"></div>
            
            <!-- Seção de Feedback -->
            <div class="feedback-section" id="feedback-section" style="display: none;">
                <h3 class="feedback-title">Como foi sua experiência? Deixe seu feedback!</h3>
                <p style="text-align: center; color: #666; margin-bottom: 1rem; font-size: 0.9rem;">
                    Você pode editar seu feedback a qualquer momento
                </p>
                
                <div class="feedback-emoji-container">
                    <div class="feedback-emoji" data-rating="1" title="Muito insatisfeito">😞</div>
                    <div class="feedback-emoji" data-rating="3" title="Neutro">😑</div>
                    <div class="feedback-emoji" data-rating="5" title="Muito satisfeito">😄</div>
                </div>
                
                <div class="feedback-text-container">
                    <label for="feedback-text" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">
                        Comentários adicionais (opcional):
                    </label>
                    <textarea 
                        id="feedback-text" 
                        class="feedback-textarea" 
                        placeholder="Conte-nos o que achou do site, sugestões de melhoria, ou qualquer comentário que gostaria de compartilhar..."
                        maxlength="500"
                    ></textarea>
                    <div style="text-align: right; font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem;">
                        <span id="char-count">0</span>/500 caracteres
                    </div>
                </div>
                
                <button class="feedback-submit" id="feedback-submit" disabled>
                    <i class="fas fa-paper-plane"></i> Enviar Feedback
                </button>
                
                <div class="feedback-success" id="feedback-success">
                    <i class="fas fa-check-circle"></i> Obrigado pelo seu feedback! Sua opinião é muito importante para nós.
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-bottom">
            <p>&copy; 2025 Verde Tech - Cidade Sustentável do Futuro - Desenvolvido por Guilherme Navasconi e Daniel Martins.</p>
        </div>
    </footer>

    <script src="script.js"></script>
    <script src="notifications.js"></script>
    <script src="gamification.js"></script>
    <script src="tutorial.js"></script>
    <script src="admin-secret.js"></script>
</body>
</html>

